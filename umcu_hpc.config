params {
    ubam_map_threads = 10
    ubam_sort_threads = 4
    ubam_bam2fq_threads = 4
}

process {
    withName: extract_not_haplotagged_contigs{
        time = { 20.m * task.attempt }
    }

    withName: phase_contig {
       time = { 20.m * task.attempt }
    }

    withName: evaluate_candidates {
       time = { 20.m * task.attempt }
       memory = { 16.GB * task.attempt }
    }

    withName: sample_probs {
       time = { 20.m * task.attempt }
    }

    withName: callCNV {
       time = { 20.m * task.attempt }
    }

    withName: modkit_phase {
       time = { 30.m * task.attempt }
    }

    withName: pileup_variants {
       time = { 30.m * task.attempt }
       memory = { 12.GB * task.attempt }
    }

    withName: post_clair_contig_haplotag {
       time = { 40.m * task.attempt }
    }

    withName: post_clair_phase_contig {
       time = { 40.m * task.attempt }
    }

    withName: makeReport{
       memory = { 4.GB * task.attempt }
    }

    withName: mosdepth_input {
       time = { 90.m * task.attempt }
    }

    withName: mosdepth {
       cpus = 8
       time = { 90.m * task.attempt }
    }

    withName: cat_haplotagged_contigs {
       cpus = 8
       time = { 90.m * task.attempt }
    }

    withName: sniffles2 {
       cpus = 8
       time = { 120.m * task.attempt }
    }

    withName: catSortBams {
       cpus = 16
       memory = { 20.GB * task.attempt }
       time = { 8.h * task.attempt }
    }

    withName: readStats {
       time = { 8.h * task.attempt }
       memory = { 20.GB * task.attempt }
       cpus = 10
    }

    withName: annotate_vcf {
       cpus = 2
    }

    withName: minimap2_alignment {
        time = { 16.h * task.attempt }
    }

    withName: aggregate_full_align_variants {
        memory = { 4.GB * task.attempt }
    }

    withName: aggregate_pileup_variants {
        memory = { 4.GB * task.attempt }
        time = { 20.m * task.attempt }
    }

    withName: cat_haplotagged_contigs {
        memory = { 32.GB * task.attempt }
    }

    withName: callCNV {
        memory = { 8.GB * task.attempt }
    }

    withName: concat_vcfs {
        memory = { 4.GB * task.attempt }
    }

    withName: post_clair_contig_haplotag {
        memory = { 20.GB * task.attempt }
    }

    withName: bam_region_filter {
        time = { 10.m * task.attempt }
    }

    withName: output_str {
        publishDir = [
            [path: "${params.out_dir}", mode: 'copy', pattern: '*.tsv'],
            [path: "${params.out_dir}", mode: 'copy', pattern: '*.vcf.gz*']
        ]
    }
}

trace {
    enabled = true
    file = "${params.out_dir}/execution/trace.txt"
    overwrite = true
    fields = 'task_id,hash,native_id,process,tag,name,status,exit,module,container,cpus,time,disk,memory,attempt,submit,start,complete,duration,realtime,queue,%cpu,%mem,rss,vmem,peak_rss,peak_vmem,rchar,wchar,syscr,syscw,read_bytes,write_bytes,vol_ctxt,inv_ctxt'
}

profiles {
    slurm {
        process {
            executor = 'slurm'
            queue = 'cpu'
            time  = '10.m'
            memory = '4.GB'
            cpu = '2'
            clusterOptions = " --gres=tmpspace:10G"
            errorStrategy = 'retry'
            maxRetries = 1
        }

        singularity {
            enabled = true
            runOptions = '-B /hpc:/hpc -B $TMPDIR:$TMPDIR'
            autoMounts = true
            cacheDir = '/hpc/diaggen/software/singularity_cache'
        }

        executor {
            queueSize = 1000
            pollInterval = '1min'
            queueStatInterval = '5min'
            submitRatelimit = '10sec'
        }
    }
}
